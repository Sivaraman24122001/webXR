<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Cube Placement</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #enter-xr-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="enter-xr-btn">Enter AR</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let xrSession = null;
        let xrReferenceSpace = null;

        async function initXR() {
            try {
                // Request XR session
                xrSession = await navigator.xr.requestSession('immersive-ar');
                xrReferenceSpace = await xrSession.requestReferenceSpace('local');

                // Set up Three.js scene
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera();
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // Add cube to the scene
                const cubeGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const cubeMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                scene.add(cube);

                // Handle session end
                xrSession.addEventListener('end', onXRSessionEnd);

                // Render loop
                function animate() {
                    xrSession.requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                }
                animate();

                // Handle tap/click to place cube
                renderer.domElement.addEventListener('click', placeCube);

                // Enter AR button visibility
                document.getElementById('enter-xr-btn').style.display = 'none';
            } catch (e) {
                console.error('Failed to enter XR session', e);
            }
        }

        function placeCube(event) {
            // Check if session and reference space are available
            if (xrSession && xrReferenceSpace) {
                // Get pose where the user tapped/clicked
                const viewerPose = xrSession.requestAnimationFrame(() => xrSession.requestHitTest(new XRHitTestSource('screen'), xrReferenceSpace)
                    .then(hitTestResults => {
                        if (hitTestResults.length > 0) {
                            const hitPose = hitTestResults[0].getPose(xrReferenceSpace);
                            if (hitPose) {
                                const { x, y, z } = hitPose.transform.position;
                                // Place the cube at the hit position
                                cube.position.set(x, y, z);
                            }
                        }
                    })
                );
            }
        }

        function onXRSessionEnd() {
            // Clean up when session ends
            if (xrSession) {
                xrSession.removeEventListener('end', onXRSessionEnd);
                xrSession = null;
                xrReferenceSpace = null;
            }
            document.getElementById('enter-xr-btn').style.display = 'block';
            // Clean up Three.js renderer
            const renderer = document.querySelector('canvas');
            renderer.parentNode.removeChild(renderer);
        }

        // Check for XR device availability
        if (navigator.xr) {
            document.getElementById('enter-xr-btn').addEventListener('click', initXR);
        } else {
            console.log('WebXR is not supported');
        }
    </script>
</body>
</html>
